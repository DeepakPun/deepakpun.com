# .github/workflows/deploy-portfolio.yml
name: Deploy Portfolio

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          envs: MONGODB_URI_API,MONGODB_URI_FULLSTACK,DOCKER_USERNAME,DOCKER_PASSWORD
          script: |
            set -e

            echo "ðŸš€ Starting deployment..."

            # Navigate to your project directory
            cd /opt/deepakpun-portfolio

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main

            # Create .env.prod using environment variables (no shell interpretation)
            echo "ðŸ“ Creating production environment file..."
            cat > .env.prod << EOF
            MONGODB_URI_API=${MONGODB_URI_API}
            MONGODB_URI_FULLSTACK=${MONGODB_URI_FULLSTACK}
            NODE_ENV=production
            EOF

            # Load environment variables
            echo "ðŸ“‚ Loading environment variables..."
            set -a
            source .env.prod
            set +a

            # Debug: Check if variables are loaded
            echo "ðŸ” Checking environment variables:"
            echo "MONGODB_URI_API length: ${#MONGODB_URI_API}"
            echo "MONGODB_URI_FULLSTACK length: ${#MONGODB_URI_FULLSTACK}"
            echo "NODE_ENV: $NODE_ENV"

            # Verify variables are loaded
            if [[ ${#MONGODB_URI_API} -lt 10 ]]; then
              echo "âŒ MONGODB_URI_API too short or empty"
              exit 1
            fi

            if [[ ${#MONGODB_URI_FULLSTACK} -lt 10 ]]; then
              echo "âŒ MONGODB_URI_FULLSTACK too short or empty"
              exit 1
            fi

            echo "âœ… Environment variables loaded successfully"

            # Docker operations
            echo "ðŸ³ Logging into Docker Hub..."
            echo "${DOCKER_PASSWORD}" | docker login -u "${DOCKER_USERNAME}" --password-stdin

            echo "ðŸ“¥ Pulling latest images..."
            docker compose -f docker-compose.prod.yml pull

            echo "ðŸ›‘ Stopping existing services..."
            docker compose -f docker-compose.prod.yml down

            echo "ðŸš€ Starting updated services..."
            docker compose -f docker-compose.prod.yml up -d

            echo "â³ Waiting for services to start..."
            sleep 30

            echo "ðŸ” Checking service status..."
            docker compose -f docker-compose.prod.yml ps

            echo "ðŸ“‹ Checking service logs for MongoDB connection..."
            docker compose -f docker-compose.prod.yml logs --tail=5 api || echo "API logs not available"
            docker compose -f docker-compose.prod.yml logs --tail=5 full-stack || echo "FullStack logs not available"

            echo "ðŸŽ‰ Deployment complete!"
            echo "ðŸŒ Services should be available at:"
            echo "   Landing: http://$(curl -s ifconfig.me):8080"
            echo "   UI: http://$(curl -s ifconfig.me):3000"
            echo "   API: http://$(curl -s ifconfig.me):3001"
            echo "   FullStack: http://$(curl -s ifconfig.me):3002"
        env:
          MONGODB_URI_API: ${{ secrets.MONGODB_URI_API }}
          MONGODB_URI_FULLSTACK: ${{ secrets.MONGODB_URI_FULLSTACK }}
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
