name: Deploy Portfolio

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          script: |
            set -e

            echo "üöÄ Starting deployment..."

            # Use the correct project directory
            PROJECT_DIR="/opt/deepakpun-portfolio"

            # Navigate to project directory
            cd "$PROJECT_DIR"

            # Pull latest code
            echo "üì• Pulling latest code..."
            git pull origin main

            # Debug: Show current directory and files
            echo "üìç Current directory: $(pwd)"
            echo "üìÅ Directory contents:"
            ls -la

            # Create .env.prod with secrets
            echo "üìù Creating production environment file..."
            cat > .env.prod << 'EOF'
            MONGODB_URI_API=${{ secrets.MONGODB_URI_API }}
            MONGODB_URI_FULLSTACK=${{ secrets.MONGODB_URI_FULLSTACK }}
            NODE_ENV=production
            EOF

            # Debug: Check if .env.prod was created
            echo "üìã Environment file created:"
            ls -la .env.prod
            echo "üìã Environment file contents (masked):"
            sed 's/mongodb+srv:\/\/[^@]*@/mongodb+srv:\/\/***:***@/g' .env.prod

            # Load environment variables
            echo "üìÇ Loading environment variables..."
            set -a
            source .env.prod
            set +a

            # Debug: Check if variables are loaded (without exposing secrets)
            echo "üîç Checking environment variables:"
            echo "MONGODB_URI_API length: ${#MONGODB_URI_API}"
            echo "MONGODB_URI_FULLSTACK length: ${#MONGODB_URI_FULLSTACK}"
            echo "NODE_ENV: $NODE_ENV"

            # Verify variables are loaded
            if [[ -z "$MONGODB_URI_API" ]]; then
              echo "‚ùå MONGODB_URI_API not loaded"
              echo "üîç GitHub secrets debug:"
              echo "Secret length from GitHub: ${{ secrets.MONGODB_URI_API && 'SET' || 'NOT SET' }}"
              exit 1
            fi

            if [[ -z "$MONGODB_URI_FULLSTACK" ]]; then
              echo "‚ùå MONGODB_URI_FULLSTACK not loaded"
              echo "üîç GitHub secrets debug:"
              echo "Secret length from GitHub: ${{ secrets.MONGODB_URI_FULLSTACK && 'SET' || 'NOT SET' }}"
              exit 1
            fi

            echo "‚úÖ Environment variables loaded successfully"

            # Check if docker-compose file exists
            COMPOSE_FILE="docker-compose.prod.yml"
            if [[ ! -f "$COMPOSE_FILE" ]]; then
              echo "‚ùå $COMPOSE_FILE not found"
              echo "üìÅ Available compose files:"
              ls -la *.yml *.yaml docker-compose* 2>/dev/null || echo "No compose files found"
              
              # Try alternative names
              if [[ -f "docker-compose.yml" ]]; then
                COMPOSE_FILE="docker-compose.yml"
                echo "‚úÖ Using docker-compose.yml instead"
              else
                exit 1
              fi
            fi

            # Docker operations
            echo "üì• Pulling latest images..."
            docker compose -f "$COMPOSE_FILE" pull || echo "‚ö†Ô∏è Some images may not exist yet"

            echo "üõë Stopping existing services..."
            docker compose -f "$COMPOSE_FILE" down

            echo "üöÄ Starting updated services..."
            docker compose -f "$COMPOSE_FILE" up -d

            echo "‚è≥ Waiting for services to start..."
            sleep 30

            echo "üîç Checking service status..."
            docker compose -f "$COMPOSE_FILE" ps

            echo "üìã Checking service logs for errors..."
            docker compose -f "$COMPOSE_FILE" logs --tail=5 api || echo "API logs not available"
            docker compose -f "$COMPOSE_FILE" logs --tail=5 full-stack || echo "FullStack logs not available"

            echo "üéâ Deployment complete!"
            echo "üåê Services should be available at:"
            echo "   Landing: http://$(curl -s ifconfig.me):8080"
            echo "   UI: http://$(curl -s ifconfig.me):3000"
            echo "   API: http://$(curl -s ifconfig.me):3001"
            echo "   FullStack: http://$(curl -s ifconfig.me):3002"
