name: Deploy Portfolio

on:
  push:
    branches: [main]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker images
        run: |
          echo "ðŸ—ï¸ Building and pushing Docker images..."

          # Build and push Landing Page
          if [[ -d "landing-page" ]]; then
            echo "ðŸ“¦ Building Landing Page..."
            cd landing-page
            docker build -t pundeepak/portfolio-landing:latest .
            docker push pundeepak/portfolio-landing:latest
            cd ..
          fi

          # Build and push UI
          if [[ -d "ui" ]]; then
            echo "ðŸ“¦ Building UI..."
            cd ui
            docker build -t pundeepak/portfolio-ui:latest .
            docker push pundeepak/portfolio-ui:latest
            cd ..
          fi

          # Build and push API
          if [[ -d "api" ]]; then
            echo "ðŸ“¦ Building API..."
            cd api
            docker build -t pundeepak/portfolio-api:latest .
            docker push pundeepak/portfolio-api:latest
            cd ..
          fi

          # Build and push FullStack
          if [[ -d "full-stack" ]]; then
            echo "ðŸ“¦ Building FullStack..."
            cd full-stack
            docker build -t pundeepak/portfolio-fullstack:latest .
            docker push pundeepak/portfolio-fullstack:latest
            cd ..
          fi

          echo "âœ… All images built and pushed successfully!"

      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT || 22 }}
          envs: MONGODB_URI_API,MONGODB_URI_FULLSTACK,DOCKER_HUB_TOKEN
          script: |
            set -e

            echo "ðŸš€ Starting deployment..."

            # Navigate to your project directory
            cd /opt/deepakpun-portfolio

            # Pull latest code
            echo "ðŸ“¥ Pulling latest code..."
            git pull origin main

            # Create .env.prod using environment variables
            echo "ðŸ“ Creating production environment file..."
            cat > .env.prod << EOF
            MONGODB_URI_API=${MONGODB_URI_API}
            MONGODB_URI_FULLSTACK=${MONGODB_URI_FULLSTACK}
            NODE_ENV=production
            EOF

            # Load environment variables
            echo "ðŸ“‚ Loading environment variables..."
            set -a
            source .env.prod
            set +a

            # Debug: Check if variables are loaded
            echo "ðŸ” Checking environment variables:"
            echo "MONGODB_URI_API length: ${#MONGODB_URI_API}"
            echo "MONGODB_URI_FULLSTACK length: ${#MONGODB_URI_FULLSTACK}"
            echo "NODE_ENV: $NODE_ENV"

            # Verify variables are loaded
            if [[ ${#MONGODB_URI_API} -lt 10 ]]; then
              echo "âŒ MONGODB_URI_API too short or empty"
              exit 1
            fi

            if [[ ${#MONGODB_URI_FULLSTACK} -lt 10 ]]; then
              echo "âŒ MONGODB_URI_FULLSTACK too short or empty"
              exit 1
            fi

            echo "âœ… Environment variables loaded successfully"

            # Docker operations
            echo "ðŸ³ Logging into Docker Hub..."
            echo "${DOCKER_HUB_TOKEN}" | docker login -u pundeepak --password-stdin

            echo "ðŸ“¥ Pulling latest images..."
            docker compose -f docker-compose.prod.yml pull

            echo "ðŸ›‘ Stopping existing services..."
            docker compose -f docker-compose.prod.yml down

            echo "ðŸš€ Starting updated services..."
            docker compose -f docker-compose.prod.yml up -d

            echo "â³ Waiting for services to start..."
            sleep 30

            echo "ðŸ” Checking service status..."
            docker compose -f docker-compose.prod.yml ps

            echo "ðŸ“‹ Checking service logs for MongoDB connection..."
            docker compose -f docker-compose.prod.yml logs --tail=5 api || echo "API logs not available"
            docker compose -f docker-compose.prod.yml logs --tail=5 full-stack || echo "FullStack logs not available"

            echo "ðŸŽ‰ Deployment complete!"
            echo "ðŸŒ Services should be available at:"
            echo "   Landing: http://$(curl -s ifconfig.me):8080"
            echo "   UI: http://$(curl -s ifconfig.me):3000"
            echo "   API: http://$(curl -s ifconfig.me):3001"
            echo "   FullStack: http://$(curl -s ifconfig.me):3002"
        env:
          MONGODB_URI_API: ${{ secrets.MONGODB_URI_API }}
          MONGODB_URI_FULLSTACK: ${{ secrets.MONGODB_URI_FULLSTACK }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
