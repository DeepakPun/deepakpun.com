name: Deploy Portfolio

on:
  push:
    branches: [main]

jobs:
  # ðŸ—ï¸ PHASE 1: BUILD AND PUSH DOCKER IMAGES
  build:
    name: Build and Push Images
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_TOKEN }}

      - name: Build and push Docker images
        run: |
          echo "ðŸ—ï¸ Starting build phase..."
          echo "ðŸ“¦ Building images for user: ${{ secrets.DOCKER_HUB_USERNAME }}"

          # Build and push Landing Page
          if [[ -d "landing-page" ]]; then
            echo "ðŸ“¦ Building Landing Page..."
            cd landing-page
            docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-landing:latest .
            docker push ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-landing:latest
            echo "âœ… Landing Page pushed successfully"
            cd ..
          else
            echo "âš ï¸ Landing Page directory not found"
          fi

          # Build and push UI
          if [[ -d "ui" ]]; then
            echo "ðŸ“¦ Building UI..."
            cd ui
            docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-ui:latest .
            docker push ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-ui:latest
            echo "âœ… UI pushed successfully"
            cd ..
          else
            echo "âš ï¸ UI directory not found"
          fi

          # Build and push API
          if [[ -d "api" ]]; then
            echo "ðŸ“¦ Building API..."
            cd api
            docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-api:latest .
            docker push ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-api:latest
            echo "âœ… API pushed successfully"
            cd ..
          else
            echo "âš ï¸ API directory not found"
          fi

          # Build and push FullStack
          if [[ -d "full-stack" ]]; then
            echo "ðŸ“¦ Building FullStack..."
            cd full-stack
            docker build -t ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-fullstack:latest .
            docker push ${{ secrets.DOCKER_HUB_USERNAME }}/portfolio-fullstack:latest
            echo "âœ… FullStack pushed successfully"
            cd ..
          else
            echo "âš ï¸ FullStack directory not found"
          fi

          echo "ðŸŽ‰ BUILD PHASE COMPLETE!"
          echo "ðŸ“‹ All images have been built and pushed to Docker Hub"

  # ðŸš€ PHASE 2: DEPLOY TO DIGITAL OCEAN
  deploy:
    name: Deploy to Digital Ocean
    runs-on: ubuntu-latest
    needs: build # ðŸ”— This job waits for build to complete

    steps:
      - name: Deploy to Digital Ocean Droplet
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          envs: MONGODB_URI_API,MONGODB_URI_FULLSTACK,DOCKER_HUB_TOKEN,DOCKER_HUB_USERNAME,SESSION_SECRET
          script: |
            set -e

            echo "ðŸš€ STARTING DEPLOYMENT PHASE..."
            echo "ðŸ“ Deploying to: $(hostname)"
            echo "â° Deployment started at: $(date)"

            # Navigate to your project directory
            cd /opt/deepakpun-portfolio

            # NUCLEAR CLEANUP OPTION ðŸ’¥
            echo "ðŸ’¥ Phase 1: Nuclear container cleanup..."
            docker stop $(docker ps -q) || echo "No containers to stop"
            docker rm $(docker ps -aq) || echo "No containers to remove"
            docker system prune -f || echo "System already clean"

            # Pull latest code
            echo "ðŸ“¥ Phase 2: Pulling latest code..."
            git pull origin main

            # AGGRESSIVE CONTAINER CLEANUP
            echo "ðŸ§¹ Phase 3: Performing aggressive container cleanup..."

            # Stop and remove ALL portfolio-related containers
            echo "ðŸ›‘ Stopping all portfolio containers..."
            docker ps -a --filter "name=portfolio" --format "{{.Names}}" | xargs -r docker stop || echo "No portfolio containers to stop"
            docker ps -a --filter "name=portfolio" --format "{{.Names}}" | xargs -r docker rm || echo "No portfolio containers to remove"

            # Stop and remove containers by project name pattern
            docker ps -a --filter "name=deepakpun-portfolio" --format "{{.Names}}" | xargs -r docker stop || echo "No deepakpun-portfolio containers to stop"
            docker ps -a --filter "name=deepakpun-portfolio" --format "{{.Names}}" | xargs -r docker rm || echo "No deepakpun-portfolio containers to remove"

            # Force stop containers using our ports
            echo "ðŸ”Œ Freeing up ports..."
            docker ps --filter "publish=8080" --format "{{.Names}}" | xargs -r docker stop || echo "Port 8080 free"
            docker ps --filter "publish=3000" --format "{{.Names}}" | xargs -r docker stop || echo "Port 3000 free"
            docker ps --filter "publish=3001" --format "{{.Names}}" | xargs -r docker stop || echo "Port 3001 free"
            docker ps --filter "publish=3002" --format "{{.Names}}" | xargs -r docker stop || echo "Port 3002 free"

            # Use docker-compose to ensure clean shutdown
            echo "ðŸ›‘ Docker Compose cleanup..."
            docker compose -f compose.yaml down --remove-orphans || echo "No compose services to stop"

            # Remove any dangling containers
            docker container prune -f || echo "No containers to prune"

            # Show current running containers
            echo "ðŸ“‹ Current running containers after cleanup:"
            docker ps

            # Create .env.prod using environment variables
            echo "ðŸ“ Phase 4: Creating production environment file..."
            cat > .env.prod << EOF
            MONGODB_URI_API=${MONGODB_URI_API}
            MONGODB_URI_FULLSTACK=${MONGODB_URI_FULLSTACK}
            NODE_ENV=production
            DOCKER_USERNAME=${DOCKER_HUB_USERNAME}
            SESSION_SECRET=${SESSION_SECRET}
            EOF

            # Load environment variables
            echo "ðŸ“‚ Phase 5: Loading environment variables..."
            set -a
            source .env.prod
            set +a

            # Debug: Check if variables are loaded
            echo "ðŸ” Checking environment variables:"
            echo "MONGODB_URI_API length: ${#MONGODB_URI_API}"
            echo "MONGODB_URI_FULLSTACK length: ${#MONGODB_URI_FULLSTACK}"
            echo "NODE_ENV: $NODE_ENV"
            echo "DOCKER_USERNAME: ${DOCKER_HUB_USERNAME}"

            # Verify variables are loaded
            if [[ ${#MONGODB_URI_API} -lt 10 ]]; then
              echo "âŒ MONGODB_URI_API too short or empty"
              exit 1
            fi

            if [[ ${#MONGODB_URI_FULLSTACK} -lt 10 ]]; then
              echo "âŒ MONGODB_URI_FULLSTACK too short or empty"
              exit 1
            fi

            if [[ -z "${DOCKER_HUB_USERNAME}" ]]; then
              echo "âŒ DOCKER_HUB_USERNAME not loaded"
              exit 1
            fi

            echo "âœ… Environment variables loaded successfully"

            # Docker operations
            echo "ðŸ³ Phase 6: Logging into Docker Hub..."
            echo "${DOCKER_HUB_TOKEN}" | docker login -u "${DOCKER_HUB_USERNAME}" --password-stdin

            echo "ðŸ“¥ Phase 7: Pulling latest images from Docker Hub..."
            docker compose -f compose.yaml pull

            # Final cleanup before starting
            echo "ðŸ§¹ Phase 8: Final cleanup before starting..."
            docker compose -f compose.yaml down --remove-orphans

            echo "ðŸš€ Phase 9: Starting updated services..."
            docker-compose up -d
            # docker compose -f compose.yaml up -d

            echo "â³ Phase 10: Waiting for services to start..."
            sleep 30

            echo "ðŸ” Phase 11: Checking service status..."
            docker compose -f compose.yaml ps

            echo "ðŸ“‹ Phase 12: Checking service logs for MongoDB connection..."
            docker compose -f compose.yaml logs --tail=5 api || echo "API logs not available"
            docker compose -f compose.yaml logs --tail=5 full-stack || echo "FullStack logs not available"

            echo "ðŸŽ‰ DEPLOYMENT PHASE COMPLETE!"
            echo "â° Deployment finished at: $(date)"
            echo "ðŸŒ Services should be available at:"
            echo "   Landing: http://$(curl -s ifconfig.me):8080"
            echo "   UI: http://$(curl -s ifconfig.me):3000"
            echo "   API: http://$(curl -s ifconfig.me):3001"
            echo "   FullStack: http://$(curl -s ifconfig.me):3002"

        env:
          MONGODB_URI_API: ${{ secrets.MONGODB_URI_API }}
          MONGODB_URI_FULLSTACK: ${{ secrets.MONGODB_URI_FULLSTACK }}
          DOCKER_HUB_TOKEN: ${{ secrets.DOCKER_HUB_TOKEN }}
          DOCKER_HUB_USERNAME: ${{ secrets.DOCKER_HUB_USERNAME }}
          SESSION_SECRET: ${{ secrets.SESSION_SECRET }}
