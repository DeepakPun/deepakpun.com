name: Deploy Portfolio to DigitalOcean

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

env:
  DOCKER_HUB_USERNAME: pundeepak
  REGISTRY: docker.io

jobs:
  build:
    name: Build Docker Images
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Build and Push Landing Page
      uses: docker/build-push-action@v5
      with:
        context: ./landing-page
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-landing-page:latest
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-landing-page:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and Push UI
      uses: docker/build-push-action@v5
      with:
        context: ./ui
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-ui:latest
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-ui:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and Push API
      uses: docker/build-push-action@v5
      with:
        context: ./api
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-api:latest
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-api:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

    - name: Build and Push Full-Stack
      uses: docker/build-push-action@v5
      with:
        context: ./full-stack
        push: true
        tags: |
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-full-stack:latest
          ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-full-stack:${{ github.sha }}
        cache-from: type=gha
        cache-to: type=gha,mode=max

  deploy:
    name: Deploy to DigitalOcean
    needs: build
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Deploy to DigitalOcean Droplet
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        port: ${{ secrets.DO_PORT || 22 }}
        script: |
          echo "ğŸš€ Starting deployment..."
          
          # Navigate to project directory
          cd /opt/deepakpun-portfolio || { echo "âŒ Project directory not found"; exit 1; }
          
          # Pull latest code
          echo "ğŸ“¥ Pulling latest code..."
          git pull origin main
          
          # Login to Docker Hub
          echo "ğŸ” Logging into Docker Hub..."
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
          
          # Pull latest images
          echo "ğŸ“¦ Pulling latest Docker images..."
          docker compose pull
          
          # Stop current services
          echo "ğŸ›‘ Stopping current services..."
          docker compose down
          
          # Start updated services
          echo "ğŸš€ Starting updated services..."
          docker compose up -d
          
          # Wait for services to start
          echo "â³ Waiting for services to start..."
          sleep 30
          
          # Show service status
          echo "ğŸ“Š Service Status:"
          docker compose ps
          
          # Clean up old images
          echo "ğŸ§¹ Cleaning up old images..."
          docker image prune -f
          
          echo "âœ… Deployment complete!"

  health-check:
    name: Health Check
    needs: deploy
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: Wait for Services
      run: sleep 60

    - name: Check Service Health
      run: |
        echo "ğŸ§ª Checking service health..."
        
        # Check main portfolio
        if curl -f -s --max-time 10 "http://${{ secrets.DO_HOST }}" > /dev/null; then
          echo "âœ… Main Portfolio: Healthy"
        else
          echo "âŒ Main Portfolio: Unhealthy"
          exit 1
        fi
        
        # Check UI service
        if curl -f -s --max-time 10 "http://${{ secrets.DO_HOST }}:3000" > /dev/null; then
          echo "âœ… UI Service: Healthy"
        else
          echo "âŒ UI Service: Unhealthy"
          exit 1
        fi
        
        # Check API service
        if curl -f -s --max-time 10 "http://${{ secrets.DO_HOST }}:3001" > /dev/null; then
          echo "âœ… API Service: Healthy"
        else
          echo "âŒ API Service: Unhealthy"
          exit 1
        fi
        
        # Check Full-Stack service
        if curl -f -s --max-time 10 "http://${{ secrets.DO_HOST }}:3002" > /dev/null; then
          echo "âœ… Full-Stack Service: Healthy"
        else
          echo "âŒ Full-Stack Service: Unhealthy"
          exit 1
        fi
        
        echo "ğŸ‰ All services are healthy!"
