name: Manual Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'production'
        type: choice
        options:
        - production
        - staging
      
      services:
        description: 'Services to Deploy'
        required: true
        default: 'all'
        type: choice
        options:
        - all
        - landing-page
        - ui
        - api
        - full-stack
      
      skip_tests:
        description: 'Skip Tests'
        required: false
        default: false
        type: boolean

env:
  DOCKER_HUB_USERNAME: pundeepak
  REGISTRY: docker.io

jobs:
  manual-deploy:
    name: Manual Deployment
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4

    - name: Display Deployment Info
      run: |
        echo "ðŸš€ Manual Deployment Started"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Services: ${{ github.event.inputs.services }}"
        echo "Skip Tests: ${{ github.event.inputs.skip_tests }}"
        echo "Triggered by: ${{ github.actor }}"

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        registry: ${{ env.REGISTRY }}
        username: ${{ secrets.DOCKER_HUB_USERNAME }}
        password: ${{ secrets.DOCKER_HUB_TOKEN }}

    - name: Build and Push Selected Services
      run: |
        SERVICES="${{ github.event.inputs.services }}"
        
        if [ "$SERVICES" = "all" ] || [ "$SERVICES" = "landing-page" ]; then
          echo "ðŸ”¨ Building Landing Page..."
          docker buildx build --push \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-landing-page:latest \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-landing-page:manual-${{ github.run_number }} \
            ./landing-page
        fi
        
        if [ "$SERVICES" = "all" ] || [ "$SERVICES" = "ui" ]; then
          echo "ðŸ”¨ Building UI..."
          docker buildx build --push \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-ui:latest \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-ui:manual-${{ github.run_number }} \
            ./ui
        fi
        
        if [ "$SERVICES" = "all" ] || [ "$SERVICES" = "api" ]; then
          echo "ðŸ”¨ Building API..."
          docker buildx build --push \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-api:latest \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-api:manual-${{ github.run_number }} \
            ./api
        fi
        
        if [ "$SERVICES" = "all" ] || [ "$SERVICES" = "full-stack" ]; then
          echo "ðŸ”¨ Building Full-Stack..."
          docker buildx build --push \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-full-stack:latest \
            --tag ${{ env.REGISTRY }}/${{ env.DOCKER_HUB_USERNAME }}/portfolio-full-stack:manual-${{ github.run_number }} \
            ./full-stack
        fi

    - name: Deploy to DigitalOcean
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: ${{ secrets.DO_HOST }}
        username: ${{ secrets.DO_USERNAME }}
        key: ${{ secrets.DO_SSH_KEY }}
        script: |
          echo "ðŸš€ Manual deployment to ${{ github.event.inputs.environment }}"
          
          cd /opt/deepakpun-portfolio
          git pull origin main
          
          echo "${{ secrets.DOCKER_HUB_TOKEN }}" | docker login -u "${{ secrets.DOCKER_HUB_USERNAME }}" --password-stdin
          
          SERVICES="${{ github.event.inputs.services }}"
          
          if [ "$SERVICES" = "all" ]; then
            echo "ðŸ”„ Restarting all services..."
            docker compose pull
            docker compose down
            docker compose up -d
          else
            echo "ðŸ”„ Restarting $SERVICES service..."
            docker compose pull $SERVICES
            docker compose up -d $SERVICES
          fi
          
          sleep 20
          docker compose ps
          
          echo "âœ… Manual deployment complete!"

    - name: Notify Deployment Status
      run: |
        echo "ðŸ“¢ Deployment Notification"
        echo "Status: âœ… Success"
        echo "Environment: ${{ github.event.inputs.environment }}"
        echo "Services: ${{ github.event.inputs.services }}"
        echo "Deployed by: ${{ github.actor }}"
        echo "Time: $(date)"
